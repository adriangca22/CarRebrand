<!DOCTYPE html>
<html lang="es">
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>


  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Burocracia Cero</title>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script type="text/javascript" src="http://www.carqueryapi.com/js/carquery.0.3.4.js"></script>
  <!-- Tus estilos personalizados -->
  <link rel="stylesheet" href="estilos.css">
  <meta charset="UTF-8">
 
  <title>Burocracia Cero</title>
  <style>
    
    .tab-container {
      display: flex;
      justify-content: space-around;
      margin-bottom: 10px;
    }

    .tab-button {
      padding: 20px 15px;
      color: #000; /* Texto negro */
   
      border: 1px solid #ccc; /* Borde gris */
      cursor: pointer;
      font-size: 16px;
      border-radius: 10px 10px 0 0;
   
      text-decoration: none; /* Eliminar subrayado del texto */
    }

    .tab-button:hover {
      color: #7a3b3b; 
    }

    .tab-button.active {
      color: #ffffff; /* Texto blanco para la pestaña activa */
      background-color: #502626; /* Fondo azul para la pestaña activa */
      border-bottom: none; /* Quitar el borde inferior en la pestaña activa */
    }

    .tab-content {
      display: none;
    }

    .tab-content.active-tab {
      display: block;
    }
      /* Estilos para los inputs con flechas */
      input {
        font-size: 14px;
    }
  </style>
</head>
<header>
<body>
  
  <nav id="main-navigation">
    <a href="#" class="logo">
        <img src="/logo.png" alt="Logotipo de la empresa">
    </a>
    <div class="nav-links">
       <a href="https://burocraciacero.com/">Inicio</a>
        <a href="#seccion1"> transferencia de vehículos</a>
       
        <a href="https://calm-customers-004738.framer.app/faq">FAQ</a>
    </div>
    <div id="whatsapp-icon">
        <a href="https://burocraciacero.com/contacto" target="_blank" class="whatsapp-button">
            <img src="/prime--whatsapp (2).svg" alt="WhatsApp">
            Contáctenos
        </a>
    </div>
</nav>



  <div class="container">
   
    
      </div>
    </div>
  </div>
  <div class="section">
    <div class="header-background">
        <div class="header-item">
            <i class="fas fa-undo"></i>
            <span>Garantía de reembolso</span>
        </div>
        <div class="header-item">
            <i class="fas fa-truck"></i>
            <span>Envío a todo al país</span>
        </div>
        <div class="header-item">
            <i class="fas fa-headset"></i>
            <span>Atención las 24 horas</span>
        </div>
        <div class="header-item">
            <i class="fas fa-clock"></i>
            <span>Documento provisional
           
        </div>
    </div>


  <div class="card-form">
    <div class="tab-container">
      <button class="tab-button" onclick="showTab('vehiculo')">1.Vehículo</button>
      <button class="tab-button" onclick="showTab('precio')">2.Precio</button>
      <button class="tab-button" onclick="showTab('pago')">3.Pago</button>
      <button class="tab-button" onclick="showTab('documentos')">4.Documentos</button>
    </div>
  
    <div id="vehiculo" class="tab-content active-tab">
      <img src="/car-citroen-vehicle-2-svgrepo-com.svg" alt="Vehículo" width="60" height="64">
  
      <form id="formVehiculo">
        <!-- Fecha de Matriculación -->
        <label for="fechaMatriculacion">Fecha de Matriculación</label>
        <div class="fecha-container">
          <input type="date" id="fechaMatriculacion" name="fechaMatriculacion" class="fecha-input" required placeholder="dd/mm/yyyy">
          <span class="fecha-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m4 7H4a2 2 0 00-2 2v7a2 2 0 002 2h16a2 2 0 002-2v-7a2 2 0 00-2-2z" />
            </svg>
          </span>
        </div>
            <!-- Marca -->
        <label for="marca">Marca</label>
        <div class="input-container">
          <input type="text" id="marca" name="marca" placeholder="Marca" required>
        </div>
         
        <!-- Modelo -->
        <label for="modelo">Modelo</label>
        <div class="input-container">
          <input type="text" id="modelo" name="modelo" placeholder="Modelo" required>
        </div>
        <!-- Comunidad Autónoma -->
        <label for="comunidadAutonomaComprador">Comunidad Autónoma del Comprador</label>
        <div class="input-container">
          <input type="text" id="comunidadAutonomaComprador" name="comunidadAutonomaComprador" placeholder="Comunidad Autónoma" required>
        </div>
   
        <!-- Combustible -->
        <label for="combustible">Combustible</label>
        <div class="input-container">
          <input type="text" id="combustible" name="combustible" placeholder="Combustible" required>
        </div>
  
       
      
  
        <!-- Precio Contrato -->
        <label for="precioContrato">Precio de compraventa (€)</label>
       
        <input type="number" id="precioContrato" name="precioContrato" placeholder="Precio de compraventa (€)" required>
      </form>
      <button type="button" id="calcularPrecioBtn" class="pepe">Calcular precio</button>
    </div>

    <div id="precio" class="tab-content">
      <h2>Precio</h2>
      <form id="formPrecio">
        <div class="precio-detalles">
          <p><strong>Cambio de nombre:</strong> <span id="totalCambio">129.85 €</span></p>
          <div id="resultadoPrecio" style="margin-top: 20px;"></div>
    
          <p><strong>Incluye:</strong></p>
          <ul>
            <li><span>Tasas DGT:</span> <span id="tasasDGT">55.70 €</span></li>
            <li><span>Gestión:</span> <span id="gestion">61.36 €</span></li>
            <li><span>IVA:</span> <span id="iva">12.89 €</span></li>
            <li><span>Envío a domicilio:</span> <span id="envio">Gratuito</span></li>
            <li>
              <span>Impuesto de transmisiones</span> 
              <a href="#" id="mostrarInfo">+info</a>: 
              <span id="impuesto">0 €</span>
            </li>
          </ul>
          
          <p><strong>Te recomendamos añadir:</strong></p>
      
          <p><strong>Total:</strong> <span id="total">129.95 €</span></p>
        </div>
      </form>
    </div>
    
    <!-- Modal -->
    <div id="modalInfo" class="modal">
      <div class="modal-content">
        <span class="close" id="cerrarModal">&times;</span>
        <h3>Impuesto de transmisiones</h3>
        <p>El Impuesto sobre Transmisiones Patrimoniales (ITP) es un tributo que el comprador debe abonar a Hacienda en los cambios de titular de un vehículo entre particulares.</p>
        <p>Se calcula aplicando un porcentaje, que varía según la comunidad autónoma del comprador, al valor más alto entre el precio acordado de compraventa y el valor venal del vehículo según las tablas de Hacienda.</p>
        <h4>Cálculo del impuesto</h4>
        <ul>
          <li>Valoración tablas hacienda: <span id="valorHacienda">16200 €</span></li>
          <li>Porcentaje de depreciación: <span id="depreciacion">34 %</span></li>
          <li>Valor fiscal: <span id="valorFiscal">0.00 €</span></li>
          <li>ITP calculado: <span id="itpCalculado">0.00 €</span></li>
        </ul>
      </div>
    </div>
   <div id="pago" class="tab-content">
      <h2>Pago</h2>
      <form id="formPago">
        <div class="pago-datos">
          <label for="nombreApellidos">Nombre y Apellidos</label>
          <input type="text" id="nombreApellidos" name="nombreApellidos" placeholder="Nombre y Apellidos" required>
    
          <label for="telefono">Teléfono</label>
          <input type="tel" id="telefono" name="telefono" placeholder="Teléfono" required>
          <!-- Correo -->
        <label for="correo">Correo</label>
        <input type="email" id="correo" name="correo" placeholder="Correo" required>
  
          <button type="button" id="verResumenBtn">Ver resumen del trámite</button>
        </div>
    
        <div class="pago-resumen">
          <p><strong>Total a pagar: <span id="pagoTotal">0.00</span> €</strong></p>
    
          <ul>
            <li><strong>Garantía de devolución</strong></li>
            <li><strong>Envío gratuito</strong></li>
            <li><strong>Atención 24/7</strong></li>
          </ul>
    
          <p><strong>Tarjeta de crédito:</strong></p>
          <input type="text" id="numeroTarjeta" placeholder="Número de tarjeta" required>
          <input type="text" id="fechaExpiracion" placeholder="Fecha de expiración" required>
          <input type="text" id="codigoSeguridad" placeholder="Código de seguridad" required>
    
          <button type="submit">Tramitar <span id="pagoTotalBoton">0.00</span> €</button>
        </div>
      </form>
    </div>
    <div id="modalDocumento" class="modal">
      <div class="modal-overlay"></div> <!-- Fondo del modal -->
      <div class="modal-content">
        <div class="modal-header">
          <img src="logo.png" alt="Logo de Burocracia" class="logo"> <!-- Logo -->
        
        </div>
        <div class="modal-body" id="documentoPreview">
          <!-- Aquí se mostrarán los datos dinámicamente -->
        </div>
        <button id="descargarPDFBtn" class="modal-button">Descargar PDF</button>
      </div>
    </div>
    
    

    <div id="documentos" class="tab-content">
      <h2>Documentos</h2>
      <p><strong>Adjuntar documentación</strong></p>
      <p style="font-size: 13px;">Ten preparada la siguiente documentación, te la pediremos:</p>
      <p style="font-size: 13px;">Es importante que la documentación que se adjunte sea de calidad.</p>
      
      <ul>
          <li><strong>DNI del comprador</strong></li>
          <li><strong>Padrón comprador</strong>: Solo si el domicilio del comprador no coincide con el DNI, deberá presentar un certificado de empadronamiento.</li>
          <li><strong>DNI del vendedor</strong></li>
          <li><strong>Ficha técnica del vehículo</strong></li>
          <li><strong>Permiso de circulación original del vehículo</strong></li>
      </ul>
  
      <p style="font-size: 13px;">Si vas a hacer fotos, te recomendamos:</p>
      <ul>
          <li>Asegúrate de evitar brillos en los documentos.</li>
          <li>Tener una buena iluminación y evitar sombras.</li>
          <li>Enfocar bien, la foto debe ser nítida y no estar borrosa.</li>
          <li>No cortar ni doblar, los documentos deben verse completos.</li>
      </ul>
  
      <!-- Área de carga de archivos -->
      <div id="dropArea" class="drop-area">
          <p>Arrastra y suelta los archivos aquí o haz clic en el botón</p>
          <input type="file" id="fileInput" multiple hidden>
          <button type="button" class="btn-adjuntar" onclick="document.getElementById('fileInput').click();">Adjuntar ahora</button>
      </div>
  
      <!-- Barra de progreso -->
      <div id="progressContainer" style="display: none; margin-top: 10px;">
          <div id="progressBar" style="width: 0%; height: 5px; background-color: green;"></div>
      </div>
  
      <!-- Lista de archivos subidos -->
      <ul id="fileList"></ul>
  
      <div class="documento-opciones">
          <button type="button" class="btn-mas-tarde">Más tarde</button>
      </div>
  </div>
  

    


  
</header>


</h2>
<h1 style="color: white;"> conoce otros servicios de Burocracia Cero</h1>
<h2 style="color: white; font-size: 13px; text-align: center; margin-bottom: 50px;">

  <br>
 
</h2>

<div class="prices">
    
    
    <div class="price-card">
        <i class="fas fa-ban icon" style="color: #5e2c2c; font-size: 24px;"></i>
        <h3>Servicio de Cancelación de Dominio</h3>
        <p class="price-details">Paquete completo<br>Envío incluido<br>Incluye gestión de ITP</p>
        <button class="price-button" onclick="window.open('https://forms.zohopublic.eu/internationalsolutionsenterp1/form/Cancelacinreservadedominio/formperma/KfIPukTCqLqOkmx4m3vxjaJWU9aVfCXPvM0_gVHa7zU', '_blank')">Más info</button>
    </div>
    
    <div class="price-card">
        <i class="fas fa-tag icon" style="color: #5e2c2c; font-size: 24px;"></i>
        <h3>Servicio de Etiqueta Ambiental DGT</h3>
        <p class="price-details">Paquete completo<br>Envío incluido<br>Incluye gestión de ITP</p>
        <button class="price-button" onclick="window.open('https://etiquetadgt.burocraciacero.com/', '_blank')">Más info</button>
    </div>
    
    <div class="price-card">
        <i class="fas fa-id-card icon" style="color: #5e2c2c; font-size: 24px;"></i>
        <h3>Servicio de Duplicado de Carnet</h3>
        <p class="price-details">Paquete completo<br>Envío incluido<br>Incluye gestión de ITP</p>
        <button class="price-button" onclick="window.open('https://forms.zohopublic.eu/internationalsolutionsenterp1/form/FormsDuplicadodecarnetdeconducir/formperma/ObOXM19vcxxuZeV1IIe40DZAmoAYhqoutz_1snwrZu8', '_blank')">Más info</button>
    </div>
</div>

</div>

<script type="module" src="/server.js"></script>
<script type="module" src="/app.js"></script>
<script type="module" src="/tabla.js"></script>
 
<script>
  // Función para manejar el cambio de pestañas
  function showTab(tabId) {
    const tabs = document.querySelectorAll('.tab-content');
    const buttons = document.querySelectorAll('.tab-button');

    // Ocultar todas las secciones y eliminar la clase 'active' de los botones
    tabs.forEach(tab => tab.classList.remove('active-tab'));
    buttons.forEach(button => button.classList.remove('active'));

    // Mostrar la sección seleccionada
    const selectedTab = document.getElementById(tabId);
    if (selectedTab) {
      selectedTab.classList.add('active-tab');
    }

    // Marcar la pestaña correspondiente como activa
    const activeButton = document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`);
    if (activeButton) {
      activeButton.classList.add('active');
    }
  }

  // Inicializar las funciones al cargar el DOM
  document.addEventListener("DOMContentLoaded", () => {
    // Mostrar la primera pestaña por defecto
    showTab('vehiculo');

  

    // Inicializar autocompletados
    initializeAutocomplete();
  });

  // Función para inicializar autocompletados

 // script.js
document.addEventListener("DOMContentLoaded", function () {
  const hamburgerButton = document.getElementById("hamburger-button");
  const navLinksContainer = document.querySelector(".nav-links-container");

  hamburgerButton.addEventListener("click", function () {
    navLinksContainer.classList.toggle("active");
  });
});
</script>

    <!-- Script de Zoho SalesIQ -->
    <script>
      window.$zoho = window.$zoho || {};
      window.$zoho.salesiq = window.$zoho.salesiq || { ready: function() {} };

      (function() {
          var d = document;
          var s = d.createElement("script");
          s.src = "https://salesiq.zohopublic.eu/widget?wc=siq45ca2ee213a30162bc0b1cd88d271ebca1e8b1b631be7969995062c80d04bfa95c8dcf3a8994897cd11ade72f04cc865";
          s.defer = true;
          d.getElementsByTagName("body")[0].appendChild(s);
      })();
  </script>
</body>
<footer>
  <div class="footer-container">
      <div class="footer-logo">
          <img src="buro.png" alt="Burocracia Cero">
          <p>Distribuidor autorizado de transferencias vehicular </p>
      </div>
      <div class="footer-contact">
          <h4>Contactar</h4>
          <ul>
              <li><a href="#">Contacto</a></li>
              <li><a href="mailto:info@burocraciacero.com">info@burocraciacero.com</a></li>
          </ul>
      </div>
      <div class="footer-legal">
          <h4>Avisos Legales</h4>
          <ul>
              <li><a href="https://calm-customers-004738.framer.app/avisos-legales">Aviso Legal</a></li>
          
          </ul>
      </div>
  </div>
  <div class="footer-bottom">
     
      <p>Copyright © 2025 International Solutions Enterprise LLC – Derechos Reservados</p>
  </div>
</footer>

<style>
  footer {
      background-color: #612f2f;
      color: white;
      padding: 30px 0;
      text-align: center;
      font-family: Arial, sans-serif;
  }

  .footer-container {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      max-width: 1200px;
      margin: 0 auto;
  }

  .footer-logo img {
      width: 150px;
      margin-bottom: 10px;
  }

  .footer-logo p {
      font-size: 14px;
  }

  .footer-contact h4, 
  .footer-legal h4 {
      margin-bottom: 10px;
  }

  .footer-contact ul, 
  .footer-legal ul {
      list-style: none;
      padding: 0;
  }

  .footer-contact ul li, 
  .footer-legal ul li {
      margin: 5px 0;
  }

  .footer-contact ul li a, 
  .footer-legal ul li a {
      color: white;
      text-decoration: none;
      font-size: 14px;
  }

  .footer-contact ul li a:hover, 
  .footer-legal ul li a:hover {
      text-decoration: underline;
  }

  .footer-bottom {
      margin-top: 20px;
      text-align: center;
      border-top: 1px solid #ffffff40;
      padding-top: 15px;
  }

  .footer-button {
      background-color: #0056b3;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 5px;
      margin-bottom: 10px;
  }

  .footer-button:hover {
      background-color: #003d7a;
  }

  .footer-bottom p {
      font-size: 12px;
      opacity: 0.8;
  }
</style>

</html>
<script>
  // Importa las funciones necesarias desde Firebase y otros módulos
import { app, db } from "./firebase.js"; // Asegúrate de que en firebase.js esté correctamente inicializado Firebase
import { collection, getDocs, addDoc } from "firebase/firestore";


// Referencia a la colección de vehículos
const vehiculosCollection = collection(db, "Vehículo");

// Coeficientes de depreciación para vehículos de turismo, todo terreno, quads, motocicletas
const coeficientesDepreciacionVehiculos = [
  { años: 1, coef: 1.0 }, // 100%
  { años: 2, coef: 0.84 }, // 84%
  { años: 3, coef: 0.67 }, // 67%
  { años: 4, coef: 0.56 }, // 56%
  { años: 5, coef: 0.47 }, // 47%
  { años: 6, coef: 0.39 }, // 39%
  { años: 7, coef: 0.34 }, // 34%
  { años: 8, coef: 0.28 }, // 28%
  { años: 9, coef: 0.24 }, // 24%
  { años: 10, coef: 0.19 }, // 19%
  { años: 11, coef: 0.17 }, // 17%
  { años: 12, coef: 0.13 }, // 13%
  { años: Infinity, coef: 0.10 } // 10% para más de 12 años
];

// Coeficientes de comunidades autónomas
const coeficientesComunidad = {
  "Andalucía": 0.90,
  "Aragón": 0.93,
  "Asturias": 0.94,
  "Islas Baleares": 0.96,
  "Canarias": 0.85,
  "Cantabria": 0.95,
  "Castilla-La Mancha": 0.89,
  "Castilla y León": 0.91,
  "Cataluña": 0.95,
  "Comunidad Valenciana": 0.88,
  "Extremadura": 0.87,
  "Galicia": 0.92,
  "La Rioja": 0.90,
  "Madrid": 1.0,
  "Murcia": 0.89,
  "Navarra": 1.0,
  "País Vasco": 1.0,
  "Ceuta": 0.80,
  "Melilla": 0.80
};

// Función para listar vehículos
async function listarVehiculos() {
  const tbody = document.getElementById("tablaVehiculos").querySelector("tbody");
  tbody.innerHTML = "";
  try {
    const querySnapshot = await getDocs(vehiculosCollection);
    querySnapshot.forEach((doc) => {
      const data = doc.data();
      const row = `
        <tr>
          <td>${data.FechaMatriculacion}</td>
          <td>${data.ComunidadAutonoma}</td>
          <td>${data.Combustible}</td>
       
          <td>${data.Marca}</td>
          <td>${data.Modelo}</td>
          <td>${data.PrecioContrato}</td>
        </tr>
      `;
      tbody.innerHTML += row;
    });
  } catch (error) {
    console.error("Error al listar los vehículos:", error);
  }
}

// Función para calcular el valor venal de vehículos
function calcularValorVenal(valorBase, fechaMatriculacion, comunidad) {
  let añoActual = new Date().getFullYear();
  let añoVehiculo = new Date(fechaMatriculacion).getFullYear();
  let antigüedad = añoActual - añoVehiculo;

  // Obtener el coeficiente de depreciación según la antigüedad
  let coefDepreciacion = coeficientesDepreciacionVehiculos.find(c => antigüedad >= c.años)?.coef || 0.10;

  // Obtener el coeficiente de la comunidad autónoma
  let coefComunidad = coeficientesComunidad[comunidad] || 1.0;

  // Calcular el valor venal
  return valorBase * coefDepreciacion * coefComunidad;
}

// Función para calcular el ITP
function calcularITP(valorVenal, porcentajeITP) {
  return valorVenal * (porcentajeITP / 100);
}

// Función para actualizar los valores en el modal
function actualizarModal(valorHacienda, depreciacion, valorFiscal, itp) {
  if (document.getElementById("valorHacienda")) {
    document.getElementById("valorHacienda").textContent = `${valorHacienda.toFixed(2)} €`;
  }
  if (document.getElementById("depreciacion")) {
    document.getElementById("depreciacion").textContent = `${(depreciacion * 100).toFixed(0)} %`;
  }
  if (document.getElementById("valorFiscal")) {
    document.getElementById("valorFiscal").textContent = `${valorFiscal.toFixed(2)} €`;
  }
  if (document.getElementById("itpCalculado")) {
    document.getElementById("itpCalculado").textContent = `${itp.toFixed(2)} €`;
  }
}

// Función para calcular el precio final SIN GUARDAR EN FIREBASE
function calcularPrecioSinGuardar() {
  const fechaMatriculacion = document.getElementById("fechaMatriculacion")?.value;
  const comunidadAutonoma = document.getElementById("comunidadAutonomaComprador")?.value;
  const precioContrato = parseFloat(document.getElementById("precioContrato")?.value);
  const marca = document.getElementById("marca")?.value;
  const modelo = document.getElementById("modelo")?.value;

  if (!validarFormulario()) {
    return;
  }

  // Valor base de Hacienda específico para el modelo Abarth 124 Spider TB Multiair 6V
  const valorBaseHacienda = 32800; // Valor de tablas de Hacienda para el modelo específico

  // Calcular la antigüedad
  const antigüedad = new Date().getFullYear() - new Date(fechaMatriculacion).getFullYear();

  // Obtener el coeficiente de depreciación según la antigüedad
  const depreciacion = coeficientesDepreciacionVehiculos.find(c => antigüedad >= c.años)?.coef || 0.10;

  // Calcular el valor fiscal
  const valorFiscal = calcularValorVenal(valorBaseHacienda, fechaMatriculacion, comunidadAutonoma);

  // Calcular el ITP (4% sobre el valor más alto entre el precio de compraventa y el valor fiscal)
  const porcentajeITP = 4;
  const baseITP = Math.max(precioContrato, valorFiscal); // Usar el valor más alto
  const impuesto = calcularITP(baseITP, porcentajeITP);

  // Calcular el total (incluyendo tasas DGT, gestión, IVA y costos adicionales)
  const tasasDGT = 55.70;
  const gestion = 61.36;
  const iva = 12.89;
  const costoAdicional1 = 12; // Ejemplo: Seguro temporal
  const costoAdicional2 = 9.90; // Ejemplo: Otro servicio
  const total = tasasDGT + gestion + iva + impuesto + costoAdicional1 + costoAdicional2;

  // Mostrar resultados en la interfaz
  document.getElementById("tasasDGT").textContent = `${tasasDGT.toFixed(2)} €`;
  document.getElementById("gestion").textContent = `${gestion.toFixed(2)} €`;
  document.getElementById("iva").textContent = `${iva.toFixed(2)} €`;
  document.getElementById("impuesto").textContent = `${impuesto.toFixed(2)} €`;
  document.getElementById("total").textContent = `${total.toFixed(2)} €`;

  // Actualizar el modal con los valores calculados
  actualizarModal(valorBaseHacienda, depreciacion, valorFiscal, impuesto);
}

// Función para calcular el precio final y enviar datos a Firebase
async function calcularPrecioYGuardar() {
  calcularPrecioSinGuardar(); // Primero calcula los precios

  // Obtener los valores del formulario
  const fechaMatriculacion = document.getElementById("fechaMatriculacion")?.value;
  const comunidadAutonoma = document.getElementById("comunidadAutonomaComprador")?.value;
  const precioContrato = parseFloat(document.getElementById("precioContrato")?.value);
  const combustible = document.getElementById("combustible")?.value;
  const correo = document.getElementById("correo")?.value;
  const marca = document.getElementById("marca")?.value;
  const modelo = document.getElementById("modelo")?.value;

  // Obtener los valores calculados
  const valorFiscal = parseFloat(document.getElementById("valorFiscal").textContent.replace(" €", ""));
  const impuesto = parseFloat(document.getElementById("impuesto").textContent.replace(" €", ""));
  const total = parseFloat(document.getElementById("total").textContent.replace(" €", ""));

  // Guardar los datos en Firebase
  const nuevoRegistro = {
    FechaMatriculacion: fechaMatriculacion,
    ComunidadAutonoma: comunidadAutonoma,
    Combustible: combustible,
    Correo: correo,
    Marca: marca,
    Modelo: modelo,
    PrecioContrato: precioContrato,
    ValorFiscal: valorFiscal,
    ITP: impuesto,
    Total: total,
    FechaRegistro: new Date().toISOString()
  };

  try {
    await addDoc(vehiculosCollection, nuevoRegistro);
    console.log("Datos guardados correctamente en Firebase.");
    listarVehiculos(); // Actualizar la tabla después de guardar
  } catch (error) {
    console.error("Error al guardar en Firebase:", error.message || error);
    alert("Hubo un error al guardar los datos. Detalles: " + (error.message || error));
  }

  showTab('precio');
}

function validarFormulario() {
  const fechaMatriculacion = document.getElementById("fechaMatriculacion")?.value;
  const comunidadAutonoma = document.getElementById("comunidadAutonomaComprador")?.value;
  const precioContrato = parseFloat(document.getElementById("precioContrato")?.value);
  const combustible = document.getElementById("combustible")?.value;
  const marca = document.getElementById("marca")?.value;
  const modelo = document.getElementById("modelo")?.value;

  // Validar campos obligatorios (excepto correo)
  if (
    !fechaMatriculacion ||
    !comunidadAutonoma ||
    isNaN(precioContrato) ||
    !combustible ||
    !marca ||
    !modelo
  ) {
    alert("Por favor, completa todos los campos obligatorios.");
    return false;
  }


  return true;
}

// Asociar eventos a botones y formularios
document.getElementById("calcularPrecioBtn")?.addEventListener("click", calcularPrecioYGuardar);
document.addEventListener("DOMContentLoaded", listarVehiculos);

// Función para cambiar de pestañas
function showTab(tabId) {
  document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active-tab'));
  document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
  document.getElementById(tabId).classList.add('active-tab');
  document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`).classList.add('active');
}

// Mostrar modal al hacer clic en "+info"
document.getElementById("mostrarInfo")?.addEventListener("click", function(event) {
  event.preventDefault();
  calcularPrecioSinGuardar(); // Solo calcula los precios, sin guardar en Firebase
  document.getElementById("modalInfo").style.display = "block";
});

// Cerrar modal al hacer clic en la "X"
document.getElementById("cerrarModal")?.addEventListener("click", function() {
  document.getElementById("modalInfo").style.display = "none";
});

// Cerrar modal al hacer clic fuera del contenido
window.onclick = function(event) {
  if (event.target == document.getElementById("modalInfo")) {
    document.getElementById("modalInfo").style.display = "none";
  }
};









// Función para mostrar el resumen del trámite
function mostrarResumen() {
  const total = parseFloat(document.getElementById("total").textContent.replace(" €", ""));

  // Actualizar el total en la sección de pago
  document.getElementById("pagoTotal").textContent = total.toFixed(2);
  document.getElementById("pagoTotalBoton").textContent = total.toFixed(2);

  // Mostrar el resumen
  alert(`Resumen del trámite:\nTotal a pagar: ${total.toFixed(2)} €`);
}

// Función para manejar el envío del formulario de pago con Stripe
document.getElementById("formPago").addEventListener("submit", async function (event) {
  event.preventDefault(); // Evitar el envío del formulario

  // Validar los campos del formulario de pago
  const nombreApellidos = document.getElementById("nombreApellidos").value;
  const telefono = document.getElementById("telefono").value;
  const total = parseFloat(document.getElementById("pagoTotal").textContent) * 100; // Convertir a céntimos

  if (!nombreApellidos || !telefono || isNaN(total) || total <= 0) {
    alert("Por favor, completa todos los campos y verifica el monto.");
    return;
  }

  try {
    // Llamar a la API backend para crear una sesión de pago en Stripe
    const response = await fetch("https://tu-servidor.com/crear-sesion-pago", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ amount: total, name: nombreApellidos, phone: telefono }),
    });

    const data = await response.json();
    if (!response.ok) throw new Error(data.error || "Error al procesar el pago");

    // Redirigir a la página de pago de Stripe
    const stripe = Stripe("pk_live_51OpdmhJaeP6i0xi8L4uF5lVArUwuapOlJwbovJdBec1RqDfCJzjwoDJGiHC5pDypqOyOhHXfPlvjDEZRgorZpRko00oVTCI0Xb"); // Agrega tu clave pública de Stripe
    stripe.redirectToCheckout({ sessionId: data.id });
  } catch (error) {
    alert(`Error al procesar el pago: ${error.message}`);
  }
});

// Función para actualizar el total en la sección de pago
function actualizarTotalPago() {
  const total = parseFloat(document.getElementById("total").textContent.replace(" €", ""));
  document.getElementById("pagoTotal").textContent = total.toFixed(2);
  document.getElementById("pagoTotalBoton").textContent = total.toFixed(2);
}

// Llamar a actualizarTotalPago cuando se calcule el precio
document.getElementById("calcularPrecioBtn").addEventListener("click", function () {
  calcularPrecioYGuardar(); // Solo realiza el cálculo
  actualizarTotalPago();    // Actualiza el total en la vista
});







































document.addEventListener("DOMContentLoaded", () => {
  // Función para generar la vista previa del documento
  function generarVistaPrevia() {
    const documentoPreview = document.getElementById("documentoPreview");
    if (!documentoPreview) return;
    // Obtener los datos del formulario
    const fechaMatriculacion = document.getElementById("fechaMatriculacion")?.value || "No especificado";
    const marca = document.getElementById("marca")?.value || "No especificado";
    const modelo = document.getElementById("modelo")?.value || "No especificado";
    const comunidadAutonoma = document.getElementById("comunidadAutonomaComprador")?.value || "No especificado";
    const combustible = document.getElementById("combustible")?.value || "No especificado";
    const correo = document.getElementById("correo")?.value || "No especificado";
    const precioContrato = document.getElementById("precioContrato")?.value || "No especificado";
    // Obtener los valores de la sección de pago
    const nombreApellidos = document.getElementById("nombreApellidos")?.value.trim() || "No especificado";
    const telefono = document.getElementById("telefono")?.value.trim() || "No especificado";
   
    const tasasDGT = document.getElementById("tasasDGT")?.textContent || "0 €";
    const gestion = document.getElementById("gestion")?.textContent || "0 €";
    const iva = document.getElementById("iva")?.textContent || "0 €";
    const impuesto = document.getElementById("impuesto")?.textContent || "0 €";
    const total = document.getElementById("total")?.textContent || "0 €";
    // Crear el contenido del documento
    const contenido = `
      <h3>Documento de Trámite</h3>
      <p><strong>Fecha de Matriculación:</strong> ${fechaMatriculacion}</p>
      <p><strong>Marca:</strong> ${marca}</p>
      <p><strong>Modelo:</strong> ${modelo}</p>
      <p><strong>Comunidad Autónoma del Comprador:</strong> ${comunidadAutonoma}</p>
      <p><strong>Combustible:</strong> ${combustible}</p>

      <p><strong>Precio de Compraventa:</strong> ${precioContrato} €</p>
      <hr>
      <h4>Datos de Usuario</h4>
      <p><strong>Nombre y Apellidos:</strong> ${nombreApellidos}</p>
      <p><strong>Teléfono:</strong> ${telefono}</p>
       <p><strong>Correo:</strong> ${correo}</p>

      <hr>
      <h4>Detalles del Cálculo</h4>
      <p><strong>Tasas DGT:</strong> ${tasasDGT}</p>
      <p><strong>Gestión:</strong> ${gestion}</p>
      <p><strong>IVA:</strong> ${iva}</p>
      <p><strong>Impuesto de Transmisiones:</strong> ${impuesto}</p>
      <p><strong>Total:</strong> ${total}</p>
      <hr>
      <p><strong>Envío a domicilio:</strong> Gratuito</p>
    `;
    // Mostrar el contenido en el modal
    documentoPreview.innerHTML = contenido;
    document.getElementById("modalDocumento").style.display = "block";
  }

  // Función para cerrar el modal de vista previa
  function cerrarModalDocumento() {
    const modal = document.getElementById("modalDocumento");
    if (modal) {
      modal.style.display = "none";
    }
  }

  // Función para cerrar el modal al hacer clic fuera o presionar "Esc"
  function cerrarModalFuera(event) {
    const modal = document.getElementById("modalDocumento");
    if (event.target === modal) {
      modal.style.display = "none";
    }
  }

  function cerrarModalConEsc(event) {
    if (event.key === "Escape") {
      cerrarModalDocumento();
    }
  }

  // Función para descargar el documento en PDF con mejor formato
  function descargarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Agregar el logo en la parte superior
    const logoImg = new Image();
    logoImg.src = "logo.png"; // Ruta relativa o absoluta del logo

    // Esperar a que la imagen cargue antes de agregarla al PDF
    logoImg.onload = () => {
      // Agregar el logo en la posición deseada
      doc.addImage(logoImg, "PNG", 10, 10, 50, 20); // x, y, ancho, alto

      // Agregar título
      doc.setFont("helvetica", "bold");
      doc.setFontSize(16);
      doc.text("Documento de Trámite", 10, 40); // Ajustar la posición después del logo

      // Obtener el contenido del documento sin etiquetas HTML
      const documentoTexto = document.getElementById("documentoPreview").innerText.trim();

      // Definir ancho de texto y margen
      const marginLeft = 10;
      const marginTop = 50; // Ajustar margen superior después del logo
      const maxWidth = 180; // Evita que el texto se corte
      const lineHeight = 7;

      // Agregar contenido con ajuste automático
      doc.setFont("helvetica", "normal");
      doc.setFontSize(12);
      const lines = doc.splitTextToSize(documentoTexto, maxWidth);
      doc.text(lines, marginLeft, marginTop + lineHeight);

      // Guardar como archivo PDF
      doc.save("documento_tramite.pdf");
    };

    // Manejar errores si la imagen no se carga correctamente
    logoImg.onerror = () => {
      console.error("Error al cargar el logo.");
    };
  }

  // Asociar eventos a botones
  document.getElementById("verResumenBtn")?.addEventListener("click", generarVistaPrevia);
  document.getElementById("cerrarModalDocumentoBtn")?.addEventListener("click", cerrarModalDocumento);
  document.getElementById("descargarPDFBtn")?.addEventListener("click", descargarPDF);
  document.getElementById("modalDocumento")?.addEventListener("click", cerrarModalFuera);
  document.addEventListener("keydown", cerrarModalConEsc);
});







import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-storage.js";
        
        const storage = getStorage();
        const inputFile = document.getElementById("fileInput");
        const dropArea = document.getElementById("dropArea");
        const fileList = document.getElementById("fileList");
        const progressContainer = document.getElementById("progressContainer");
        const progressBar = document.getElementById("progressBar");
        const progressText = document.getElementById("progressText");

        const allowedFormats = ["image/jpeg", "image/png", "application/pdf"];
        const maxFileSize = 5 * 1024 * 1024; 

        dropArea.addEventListener("dragover", (event) => {
            event.preventDefault();
            dropArea.classList.add("dragging");
        });

        dropArea.addEventListener("dragleave", () => {
            dropArea.classList.remove("dragging");
        });

        dropArea.addEventListener("drop", (event) => {
            event.preventDefault();
            dropArea.classList.remove("dragging");
            handleFiles(event.dataTransfer.files);
        });

        inputFile.addEventListener("change", () => {
            handleFiles(inputFile.files);
        });

        function handleFiles(files) {
            for (let file of files) {
                if (!allowedFormats.includes(file.type)) {
                    alert("Formato no permitido. Solo JPG, PNG y PDF");
                    continue;
                }
                if (file.size > maxFileSize) {
                    alert("El archivo supera el límite de 5MB");
                    continue;
                }
                uploadFile(file);
            }
        }

        function uploadFile(file) {
            const storageRef = ref(storage, `documentos/${file.name}`);
            const uploadTask = uploadBytesResumable(storageRef, file);

            progressContainer.style.display = "block";
            progressText.innerText = `Subiendo ${file.name}...`;

            uploadTask.on("state_changed",
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    progressBar.style.width = progress + "%";
                    progressText.innerText = `Subiendo ${file.name}: ${Math.round(progress)}%`;
                },
                (error) => {
                    alert("Error al subir archivo: " + error.message);
                    progressContainer.style.display = "none";
                },
                () => {
                    getDownloadURL(uploadTask.snapshot.ref).then((downloadURL) => {
                        progressText.innerText = "Subida completa";
                        setTimeout(() => {
                            progressContainer.style.display = "none";
                        }, 1000);
                        displayFile(file.name, downloadURL);
                    });
                }
            );
        }

        function displayFile(name, url) {
            const li = document.createElement("li");
            li.innerHTML = `<a href="${url}" target="_blank">${name}</a> <button onclick="removeFile('${name}', '${url}')">Eliminar</button>`;
            fileList.appendChild(li);
        }

        function removeFile(fileName, fileUrl) {
            const storageRef = ref(storage, `documentos/${fileName}`);
            deleteObject(storageRef).then(() => {
                alert("Archivo eliminado correctamente");
                removeFileFromList(fileUrl);
            }).catch((error) => {
                alert("Error al eliminar archivo: " + error.message);
            });
        }

        function removeFileFromList(url) {
            const items = fileList.getElementsByTagName("li");
            for (let item of items) {
                if (item.querySelector("a").href === url) {
                    fileList.removeChild(item);
                    break;
                }
            }
        }
</script>
   
